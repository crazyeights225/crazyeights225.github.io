<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>crazyeights225</title>
   
    <link rel="stylesheet" href="../assets/bulma.min.css">
    <link rel="stylesheet" href="../static/default.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script>
    <style>
      span{margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;}pre{padding:0.5rem 0.5rem!important;}
    </style>
  </head>
  <body>
    <div id="app" class="mt-2">
        <nav class="navbar container" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
              <a class="navbar-item" href="/">
                <img src="../assets/logo.png">
              </a>
              <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
              </a>
            </div>
            <div id="navbar" class="navbar-menu">
              <div class="navbar-start">
                    <a href="../index.html" class="navbar-item">Posts</a>
                    <a href="../projects.html" class="navbar-item">Projects</a>
              </div>
            </div>
          </nav>
    </div>
    <div class="hero-body mt-2" style="background-color: #285aff;">
        <div class="container has-text-centered">
            <h1 class="title" style="color: #f1f1f1;">
                Learning Vagrant
            </h1>
            <h2 class="subtitle" style="color: #f1f1f1;">
                Dec, 2020
            </h2>
        </div>
    </div>
</section>
<section class="container mt-2">
<div class="content column is-10">
    <nav class="breadcrumb mb-5" aria-label="breadcrumbs">
        <ul>
          <li><a href="../index.html">Posts</a></li>
          <li><a href="../notes.html">Notes + Tutorials</a></li>
          <li class="is-active"><a href="#" aria-current="page">Learning Vagrant</a></li>
        </ul>
      </nav>
      <br>
      <p>"Vagrant is an open-source tool that allows you to create, configure, and manage boxes of virtual machines through an easy to use command-line interface"</p>
      <hr>
      <h4>Installing:</h4>
      <ul>
      <li>Is available from apt</li>
      </ul>
      <pre><code><span>sudo apt-get install vagrant</span></code></pre>
      <h3>Creating a Test Project:</h3>
      <pre><code><span>mkdir Vagrant_Hello_World
      cd Vagrant_Hello_World/</span></code></pre>
      <h3>Create a VagrantFile with default config:</h3>
      <pre><code><span>vagrant init
      
      
      A `Vagrantfile` has been placed in this directory. You are now
      ready to `vagrant up` your first virtual environment! Please read
      the comments in the Vagrantfile as well as documentation on
      `vagrantup.com` for more information on using Vagrant.
      </span></code></pre>
      <p>The default VagrantFile:</p>
      <pre><code><span># -*- mode: ruby -*-
      # vi: set ft=ruby :
      
      # All Vagrant configuration is done below. The "2" in Vagrant.configure
      # configures the configuration version (we support older styles for
      # backwards compatibility). Please don't change it unless you know what
      # you're doing.
      Vagrant.configure("2") do |config|
        # The most common configuration options are documented and commented below.
        # For a complete reference, please see the online documentation at
        # https://docs.vagrantup.com.
      
        # Every Vagrant development environment requires a box. You can search for
        # boxes at https://vagrantcloud.com/search.
        config.vm.box = "base"
      [SNIP]
      </pre></code>
      <p>Replace Line 15 in VagrantFile with the desired OS:</p>
      <ul>
      <li>Find available OS's here: https://app.vagrantup.com/boxes/search</li>
      </ul>
      <pre><code><span>config.vm.box = &quot;base&quot;
      </span></code></pre>
      <p>Using the newest version of ubuntu: <a href="https://app.vagrantup.com/generic/boxes/ubuntu2010">https://app.vagrantup.com/generic/boxes/ubuntu2010</a></p>
      <pre><code><span>config.vm.box = &quot;generic/ubuntu2010&quot;
      </span></code></pre>
      <p>Start the machine using up, this will fail because the OS doesn't exist locally. It will then install the machine and start the machine when it has finished.</p>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ vagrant up
      Bringing machine 'default' up with 'virtualbox' provider...
      ==&gt; default: Box 'generic/ubuntu2010' could not be found. Attempting to find and install...
          default: Box Provider: virtualbox
          default: Box Version: &gt;= 0
      ==&gt; default: Loading metadata for box 'generic/ubuntu2010'
          default: URL: https://vagrantcloud.com/generic/ubuntu2010
      ==&gt; default: Adding box 'generic/ubuntu2010' (v3.1.16) for provider: virtualbox
          default: Downloading: https://vagrantcloud.com/generic/boxes/ubuntu2010/versions/3.1.16/providers/virtualbox.box
      Download redirected to host: vagrantcloud-files-production.s3.amazonaws.com
          default: Calculating and comparing box checksum...
      ==&gt; default: Successfully added box 'generic/ubuntu2010' (v3.1.16) for 'virtualbox'!
      ==&gt; default: Importing base box 'generic/ubuntu2010'...
      ==&gt; default: Matching MAC address for NAT networking...
      ==&gt; default: Checking if box 'generic/ubuntu2010' version '3.1.16' is up to date...
      ==&gt; default: Setting the name of the VM: Vagrant_Hello_World_default_1608825662314_20127
      ==&gt; default: Clearing any previously set network interfaces...
      ==&gt; default: Preparing network interfaces based on configuration...
          default: Adapter 1: nat
      ==&gt; default: Forwarding ports...
          default: 22 (guest) =&gt; 2222 (host) (adapter 1)
      ==&gt; default: Running 'pre-boot' VM customizations...
      ==&gt; default: Booting VM...
      ==&gt; default: Waiting for machine to boot. This may take a few minutes...
          default: SSH address: 127.0.0.1:2222
          default: SSH username: vagrant
          default: SSH auth method: private key
          default: Warning: Remote connection disconnect. Retrying...
          default: 
          default: Vagrant insecure key detected. Vagrant will automatically replace
          default: this with a newly generated keypair for better security.
          default: 
          default: Inserting generated public key within guest...
          default: Removing insecure key from the guest if it's present...
          default: Key inserted! Disconnecting and reconnecting using new SSH key...
      ==&gt; default: Machine booted and ready!
      ==&gt; default: Checking for guest additions in VM...
      
      </span></code></pre>
      <h4>List available boxes:</h4>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ vagrant box list
      generic/ubuntu2010 (virtualbox, 3.1.16)
      </span></code></pre>
      <h4>Get status:</h4>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ vagrant status
      Current machine states:
      
      default                   running (virtualbox)
      </span></code></pre>
      <h4>The newly created box is shown in virtualbox:</h4>
      <img src="images/v1.png" style="width: 80%">
      <h3>Connecting to the box via ssh:</h3>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ vagrant ssh
      
      vagrant@ubuntu2010:~$ uname -a
      Linux ubuntu2010.localdomain 5.8.0-33-generic #36-Ubuntu SMP Wed Dec 9 09:14:40 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
      vagrant@ubuntu2010:~$ exit
      logout
      Connection to 127.0.0.1 closed.
      
      </span></code></pre>
      <h4>Shutting Down the box:</h4>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ vagrant halt
      ==&gt; default: Attempting graceful shutdown of VM...
      </span></code></pre>
      <h2>Provisioning Scripts:</h2>
      <p>Create the script:</p>
      <pre><code><span>touch bootstrap.sh
      </span></code></pre>
      <p>Add the following line to VagrantFile:</p>
      <pre><code><span># Define the bootstrap file
      config.vm.provision :shell, path: &quot;bootstrap.sh&quot;
      </span></code></pre>
      <h3>Setting up a lamp stack:</h3>
      <h5>Creating a test page:</h5>
      <pre><code><span>crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ mkdir test
      crazyeights@es-base:~/Desktop/Vagrant_Hello_World$ cd test
      crazyeights@es-base:~/Desktop/Vagrant_Hello_World/test$ touch hello.php
      </span></code></pre>
      <p>Adding the following to the file:</p>
      <pre><code><span>&lt;html&gt;
       &lt;head&gt;
        &lt;title&gt;Hello World&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;
       &lt;?php echo '&lt;p&gt;Hello World&lt;/p&gt;'; ?&gt; 
       &lt;/body&gt;
      &lt;/html&gt;
      </span></code></pre>
      <h3>Use vagrant file provisioner to copy the folder test to the box:</h3>
      <ul>
      <li>Because of permissions you usually can't copy directly to /var/www/html</li>
      </ul>
      <pre><code><span>config.vm.provision :file, source: 'test/', destination: '/tmp/'
      </span></code></pre>
      <h3>Assign the box an address:</h3>
      <pre><code><span>config.vm.network &quot;private_network&quot;, ip: &quot;192.168.99.99&quot;
      </span></code></pre>
      <h3>Provisioning Script:</h3>
      <p>Create a folder for the test files, copy them from tmp to the new folder:</p>
      <pre><code><span>#!/usr/bin/env bash
      
      PROJECTFOLDER='test'
      
      #create project folder
      sudo mkdir &quot;/var/www/html/${PROJECTFOLDER}&quot;
      
      # cp the files to test:
      sudo cp /tmp/test/* &quot;/var/www/html/${PROJECTFOLDER}/&quot;
      </span></code></pre>
      <p>Install updates, and apache2, php</p>
      <pre><code><span># update / upgrade
      sudo apt-get update
      sudo apt-get -y upgrade
      
      # install apache 2 and php
      sudo apt-get install -y apache2
      sudo apt-get install -y php
      </span></code></pre>
      <p>Setup and install mysql</p>
      <pre><code><span>PASSWORD='root'
      # install mysql and give password to installer
      sudo debconf-set-selections &lt;&lt;&lt; &quot;mysql-server mysql-server/root_password password $PASSWORD&quot;
      sudo debconf-set-selections &lt;&lt;&lt; &quot;mysql-server mysql-server/root_password_again password $PASSWORD&quot;
      sudo apt-get -y install mysql-server
      sudo apt-get install php-mysql
      </span></code></pre>
      <p>Configure apache2 to have the project folder as the root dir, and restart it:</p>
      <pre><code><span>#setup hosts file
      VHOST=$(cat &lt;&lt;EOF
          &lt;VirtualHost *:80&gt;
          DocumentRoot &quot;/var/www/html/${PROJECTFOLDER}&quot;
          &lt;Directory &quot;/var/www/html/${PROJECTFOLDER}&quot;&gt;
              AllowOverride All
              Require all granted
          &lt;/Directory&gt;
          &lt;/VirtualHost&gt;
      EOF
      )
      
      echo &quot;${VHOST}&quot; &gt; /etc/apache2/sites-available/000-default.conf
      
      # enable mod_rewrite
      sudo a2enmod rewrite
      
      service apache2 restart
      </span></code></pre>
      <p>If box is not running run:</p>
      <pre><code><span>vagrant up
      </span></code></pre>
      <p>If box has already been setup, to apply the new changes run:</p>
      <pre><code><span>vagrant provision
      </span></code></pre>
      <h4>And Voila!</h4>
      <img src="images/v2.png" style="width: 80%">
      <h4>Full VagrantFile:</h4>
      <pre><code><span># -*- mode: ruby -*-
      # vi: set ft=ruby :
      
      # All Vagrant configuration is done below. The &quot;2&quot; in Vagrant.configure
      # configures the configuration version (we support older styles for
      # backwards compatibility). Please don't change it unless you know what
      # you're doing.
      Vagrant.configure(&quot;2&quot;) do |config|
        # The most common configuration options are documented and commented below.
        # For a complete reference, please see the online documentation at
        # https://docs.vagrantup.com.
      
        # Every Vagrant development environment requires a box. You can search for
        # boxes at https://vagrantcloud.com/search.
        # config.vm.box = &quot;base&quot;
        config.vm.box = &quot;generic/ubuntu2010&quot;
        
        config.vm.network &quot;private_network&quot;, ip: &quot;192.168.99.99&quot;
        
        config.vm.provision :file, source: 'test/', destination: '/tmp/'
        
        # Define the bootstrap file
        config.vm.provision :shell, path: &quot;bootstrap.sh&quot;
      
      end
      </span></code></pre>
      <h4>Full Provisioning Script:</h4>
      <pre><code><span>#!/usr/bin/env bash
      
      PROJECTFOLDER='test'
      
      #create project folder
      sudo mkdir &quot;/var/www/html/${PROJECTFOLDER}&quot;
      
      # cp the files to test:
      sudo cp /tmp/test/* &quot;/var/www/html/${PROJECTFOLDER}/&quot;
      
      # update / upgrade
      sudo apt-get update
      sudo apt-get -y upgrade
      
      # install apache 2 and php
      sudo apt-get install -y apache2
      sudo apt-get install -y php
      
      PASSWORD='root'
      # install mysql and give password to installer
      sudo debconf-set-selections &lt;&lt;&lt; &quot;mysql-server mysql-server/root_password password $PASSWORD&quot;
      sudo debconf-set-selections &lt;&lt;&lt; &quot;mysql-server mysql-server/root_password_again password $PASSWORD&quot;
      sudo apt-get -y install mysql-server
      sudo apt-get install php-mysql
      
      
      #setup hosts file
      VHOST=$(cat &lt;&lt;EOF
          &lt;VirtualHost *:80&gt;
          DocumentRoot &quot;/var/www/html/${PROJECTFOLDER}&quot;
          &lt;Directory &quot;/var/www/html/${PROJECTFOLDER}&quot;&gt;
              AllowOverride All
              Require all granted
          &lt;/Directory&gt;
          &lt;/VirtualHost&gt;
      EOF
      )
      
      echo &quot;${VHOST}&quot; &gt; /etc/apache2/sites-available/000-default.conf
      
      # enable mod_rewrite
      sudo a2enmod rewrite
      
      service apache2 restart
      
      sudo apt-get -y install git
      </span></code></pre>
      <p>This is a good article:
      <a href="https://opensource.com/article/19/12/beginner-vagrant">https://opensource.com/article/19/12/beginner-vagrant</a></p>
      <br>
</div>
</section>
<footer class="footer">
    <div class="container">
        <div class="columns">
        </div>
    </div>
</footer>
</body>